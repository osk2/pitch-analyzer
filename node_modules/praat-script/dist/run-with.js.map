{"version":3,"sources":["src/run-with.js"],"names":[],"mappings":"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","file":"dist/run-with.js","sourcesContent":["'use strict';\r\n\r\nrequire('traceur-runtime');\r\n\r\nvar child_process = require('child_process');\r\nvar tmp = require('tmp');\r\nvar fs = require('fs');\r\nvar Observable = require('rxjs').Observable;\r\n\r\nfunction castError(err) {\r\n\tif (err instanceof Error)\r\n\t\treturn err;\r\n\treturn new Error('Error ' + err);\r\n}\r\n\r\nmodule.exports = function runWith(praatExec, script, cb) {\r\n\tif (typeof cb === 'function')\r\n\t\treturn runWithCallback(praatExec, script, cb);\r\n\telse\r\n\t\treturn new Observable(observer => {\r\n\t\t\tvar controller = runWithCallback(praatExec, script, (err, res) => {\r\n\t\t\t\tif (err)\r\n\t\t\t\t\tobserver.error(err);\r\n\t\t\t\telse {\r\n\t\t\t\t\tobserver.next(res);\r\n\t\t\t\t\tobserver.complete();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\treturn controller.abort;\r\n\t\t}).share();\r\n};\r\n\r\nfunction runWithCallback(praatExec, script, cb) {\r\n\tif (!cb)\r\n\t\tcb = function() {};\r\n\tvar praat;\r\n\tvar aborted = false;\r\n\tvar controller = {\r\n\t\tabort: function() {\r\n\r\n\t\t\tif (!aborted) {\r\n\t\t\t\tif (praat) {\r\n\t\t\t\t\tpraat.kill();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\taborted = true;\r\n\t\t}\r\n\t};\r\n\ttry {\r\n\t\tif (aborted)\r\n\t\t\tthrow new Error('Aborted by caller');\r\n\t\ttmp.file({\r\n\t\t\t\tkeep: true\r\n\t\t\t},\r\n\t\t\tfunction _tempFileCreated(err, path, fd) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tvar cleanupCallback = function() {\r\n\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\tfs.closeSync(fd);\r\n\t\t\t\t\t\t} catch (e) {}\r\n\t\t\t\t\t\tfs.unlink(path);\r\n\t\t\t\t\t};\r\n\t\t\t\t\tif (err) throw castError(err);\r\n\t\t\t\t\tif (aborted)\r\n\t\t\t\t\t\tthrow new Error('Aborted by caller');\r\n\t\t\t\t\tfs.write(fd, script.toString(), 0, 'utf8', function(err) {\r\n\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\tif (err) throw castError(err);\r\n\t\t\t\t\t\t\tif (aborted)\r\n\t\t\t\t\t\t\t\tthrow new Error('Aborted by caller');\r\n\t\t\t\t\t\t\tfs.close(fd, function(err) {\r\n\t\t\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\t\t\tif (err) throw castError(err);\r\n\t\t\t\t\t\t\t\t\tif (aborted)\r\n\t\t\t\t\t\t\t\t\t\tthrow new Error('Aborted by caller');\r\n\t\t\t\t\t\t\t\t\tvar stdout = '';\r\n\t\t\t\t\t\t\t\t\tvar stderr = '';\r\n\t\t\t\t\t\t\t\t\tpraat = child_process.spawn(praatExec, ['--run', path], {\r\n\t\t\t\t\t\t\t\t\t\tstdio: ['ignore', 'ignore', 'ignore']\r\n\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\tpraat.on('close', function(err) {\r\n\t\t\t\t\t\t\t\t\t\tpraat = null;\r\n\t\t\t\t\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\t\t\t\t\tif (err) throw castError(err);\r\n\t\t\t\t\t\t\t\t\t\t\tif (stderr && stderr.length > 0)\r\n\t\t\t\t\t\t\t\t\t\t\t\tthrow new Error(stderr.toString('utf8'));\r\n\t\t\t\t\t\t\t\t\t\t\tif (aborted)\r\n\t\t\t\t\t\t\t\t\t\t\t\tthrow new Error('Aborted by caller');\r\n\t\t\t\t\t\t\t\t\t\t\tcleanupCallback();\r\n\t\t\t\t\t\t\t\t\t\t\tcb();\r\n\t\t\t\t\t\t\t\t\t\t} catch (e) {\r\n\t\t\t\t\t\t\t\t\t\t\tcleanupCallback();\r\n\t\t\t\t\t\t\t\t\t\t\tcb(e);\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t} catch (e) {\r\n\t\t\t\t\t\t\t\t\tcleanupCallback();\r\n\t\t\t\t\t\t\t\t\tcb(e);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t} catch (e) {\r\n\t\t\t\t\t\t\tcleanupCallback();\r\n\t\t\t\t\t\t\tcb(e);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\t// If we don't need the file anymore we could manually call the cleanupCallback \r\n\t\t\t\t\t// But that is not necessary if we didn't pass the keep option because the library \r\n\t\t\t\t\t// will clean after itself. \r\n\t\t\t\t} catch (e) {\r\n\t\t\t\t\tcleanupCallback();\r\n\t\t\t\t\tcb(e);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t} catch (e) {\r\n\t\tcb(e);\r\n\t}\r\n\treturn controller;\r\n};"]}